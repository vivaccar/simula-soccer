<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SimulaSoccer</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
	{% load static %}
	<link rel="stylesheet" href="{% static 'style.css' %}">
</head>
<body>
	<nav class="navbar navbar-inverse" style="background-color: rgb(155, 219, 111);">
		<div class="container-fluid">
			<div class="navbar-header">
				<a href="{% url 'home' %}" class="navbar-logo">
					<img src="{% static 'images/logo.png' %}" alt="logo">
				</a>
				<div class="menu">
					<button class="menu-button">Ver Ligas</button>
					<div class="menu-itens">
						<a href="{% url 'brasil_serie_a' %}">Brasileirão Série A</a>
						<a href="{% url 'brasil_serie_b' %}">Brasileirão Série B</a>
						<a href="{% url 'premier_league' %}">Premier League</a>
						<a href="{% url 'serie_a' %}">Serie A</a>
						<a href="{% url 'la_liga' %}">La Liga</a>
						<a href="{% url 'bundesliga' %}">Bundesliga</a>
					</div>
				</div>
			</div>
		</div>
	</nav>	
	<script>
		function getCurrentRound(){
			let currentTime = Date.now() / 1000 //transormo de milissegundos para segundos(unidade de medida dos timestamps dos games)
			var allGames = JSON.parse(localStorage.getItem('generalData'))['games']
			var curGameTime = 0
			var curRound = 1
			allGames.forEach((game, index) => {
				if ((game.timestamp) > currentTime  && ((game.timestamp) < curGameTime || curGameTime == 0)){
					curGameTime = game.timestamp
					curRound = game.round
			}})
			return (curRound)
		}
		
		const l_id = '{{ league.league_id }}'
		document.addEventListener('DOMContentLoaded', (event) => {
			getGeneralData()
		})
		function getCSRFToken() {
			return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
		}
		function getGeneralData() {
			console.log(l_id)
			fetch('get_data', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/x-www-form-urlencoded',
					'X-CSRFToken': getCSRFToken(),
				},
				body: new URLSearchParams({ 'league_id': l_id }).toString(),
			})
			.then(response => response.json())
			.then(data => {
			const generalDataJson = JSON.stringify(data);
			localStorage.setItem('generalData', generalDataJson);
			window.Round = getCurrentRound();
			printGamesRound(window.Round)
	})
}
	</script>
		<br>
		<div style="display: inline;">
			<h2 class="league_title"><img style="height: 5%; width: 5%;" src="{{ league.logo }}"></h2>
		</div>
		<div class="container-fluid">
			<div class="row" style="width: 100%; height: 120%;">
				<div class="col-lg-6 left-column">
					<br>
					<div class="table-responsive">
						<table class="table-striped">
							<thead style="background-color: gainsboro;">
								<th></th>
								<th></th>
								<th class="table-cel">P</th>
								<th class="table-cel">J</th>
								<th class="table-cel">V</th>
								<th class="table-cel">E</th>
								<th class="table-cel">D</th>
								<th class="table-cel">G</th>
								<th class="table-cel">GS</th>
								<th class="table-cel">SG</th>
								<th class="table-cel">%</th>
							</thead>
							<tbody>
								{% for team in teams_list %}
								<tr id="team_row_{{ team.id_name }}">
									<td class="text-center mb-4" {% if forloop.counter <= league.zone_1 %}style="background-color: green; color:white" 
									{% elif league.zone_2 and forloop.counter <= league.zone_2 %}style="background-color: blue; color: white" 
									{% elif league.zone_3 and forloop.counter <= league.zone_3 %}style="background-color: rgb(199, 186, 0); color: white" 
									{% elif forloop.counter >=  league.zone_reb %}style="background-color: red; color: white"
									{% endif %}>{{ forloop.counter }}</td>
									<td><img src="{{ team.logo }}" alt="" width="13%" height="13%"> {{ team.name }}</td>
									<td class="text-center mb-4">{{ team.points }}</td>
									<td class="text-center mb-4">{{ team.games_played }}</td>
									<td class="text-center mb-4">{{ team.wins }}</td>
									<td class="text-center mb-4">{{ team.draws }}</td>
									<td class="text-center mb-4">{{ team.loss }}</td>
									<td class="text-center mb-4">{{ team.goals_pro }}</td>
									<td class="text-center mb-4">{{ team.goals_con }}</td>
									<td class="text-center mb-4">{{ team.sg }}</td>
									<td class="text-center mb-4">{{ team.aproveitamento }}%</td>
								</tr>
								{% endfor %}
							</tbody>
						</table>
						<br>
						<div class="table-responsive">
							<table>
								<tr>
									<td style="background-color: green; font-size: 10px; width : 4%"> </td>
									<td> {{ league.zone_1_txt }}</td>
								</tr>
								<tr>	
									{% if league.zone_2 %}
									<td style="background-color: blue; font-size: 10px; width : 4%"> </td>
									<td> {{ league.zone_2_txt }}</td>
									{% endif %}
								</tr>
								<tr>
									{% if league.zone_3 %}
									<td style="background-color: rgb(199, 186, 0); font-size: 10px; width : 4%"> </td>
									<td> {{ league.zone_3_txt }}</td>
									{% endif %}
								</tr>
								<tr>
									<td style="background-color: red; font-size: 10px; width : 4%"> </td>
									<td> {{ league.zone_reb_txt }}</td>
								</tr>
							</table>	
						</div>
					</div>
				</div>
				<div class="right-column">
					<div class="d-flex justify-content-between align-items-center mt-4">
						<script>
							var data = [];

							function printGamesRound(round) {
								printRound()
								console.log("entrou na print round");
								var gamesContainer = document.getElementById("gamesContainer");
								var allGames = JSON.parse(localStorage.getItem('generalData'))['games'];
								console.log("all games: ", allGames);
								var allTeams = JSON.parse(localStorage.getItem('generalData'))['teams'];
								var gamesRound = allGames.filter((game) => game['round'] == round);
								gamesRound = gamesRound.sort((a, b) => a['timestamp'] - b['timestamp']);
								console.log("games round:", gamesRound);
								
								gamesContainer.innerHTML = '';
								gamesRound.forEach((game, index) => {
									var home_team = allTeams.find((team => team.name == game.home_team));
									var away_team = allTeams.find((team => team.name == game.away_team));
									var formHTML = `
									<form id="form_${game.game_id}">
										<div style="align-items: center; text-align: center; border:1px solid gainsboro;">
											<div>
												<br>
												<input type="hidden" name="home_team" value="${game.home_team}">
												<input type="hidden" name="away_team" value="${game.away_team}">
												<input type="hidden" name="game_id" value="${game.game_id}">
												<img src="${home_team.logo}" alt="" height="8%" width="8%">
												<input type="number" ${game.real_played ? 'disabled' : ''} name="home_goals" id="home_goals_${game.game_id}" min="0" max="9" value="${game.home_goals != null ? game.home_goals : ''}">
												X
												<input type="number" ${game.real_played ? 'disabled' : ''} name="away_goals" id="away_goals_${game.game_id}" min="0" max="9" value="${game.away_goals != null ? game.away_goals : ''}">
												<img src="${away_team.logo}" alt="" height="9%" width="9%">
												<p style="font-size: 12px;">${game.stadium} - ${game.local_time}</p>
											</div>
										</div>
									</form>`;
									gamesContainer.innerHTML += formHTML;
								});

								eventListener(gamesRound);
							}

							function eventListener(gamesRound) {
								gamesRound.forEach((game) => {
									var homeGoalsInput = document.getElementById(`home_goals_${game.game_id}`);
									var awayGoalsInput = document.getElementById(`away_goals_${game.game_id}`);
									
									homeGoalsInput.addEventListener('input', function() {
										checkInputs(game, homeGoalsInput, awayGoalsInput);
									});
									
									awayGoalsInput.addEventListener('input', function() {
										checkInputs(game, homeGoalsInput, awayGoalsInput);
									});
								});
							}

							function checkInputs(game, homeGoalsInput, awayGoalsInput) {
								if (homeGoalsInput.value !== '' && awayGoalsInput.value !== '' && homeGoalsInput.value >= 0 && awayGoalsInput.value >= 0) {
									game['home_goals'] = homeGoalsInput.value
									game['away_goals'] = awayGoalsInput.value
									let GameIdToFind = game.game_id;
									console.log("gameIdToFind: ", GameIdToFind);
									
									var generaldata = JSON.parse(localStorage.getItem('generalData'));
									var gamesList = generaldata['games']
									var foundGame = gamesList.find(object => object['game_id'] == GameIdToFind);
									console.log("jogo encontrado: ", foundGame)
									console.log("simulated jogo encontrado: ", foundGame['simulated'])
									if (foundGame['simulated']) {
										resetTeamsVariables(foundGame, generaldata);		
									}
									exec_game(game, generaldata);
									print_table(generaldata);
								}
							}

							function resetTeamsVariables(game, generaldata){
								console.log("entrou na resetTeams")
								let gameLocalStorage = generaldata['games'].find(object => object['game_id'] == game.game_id)
								console.log("game do ls", gameLocalStorage)
								let home_team = generaldata['teams'].find(team => team.name == game['home_team'])
								let away_team = generaldata['teams'].find(team => team.name == game['away_team'])
								home_team.games_played -= 1
								away_team.games_played -= 1
								home_team.goals_pro -= parseInt(game['home_goals'])
								home_team.goals_con -= parseInt(game['away_goals'])
								home_team.sg -= parseInt(game['home_goals']) - parseInt(game['away_goals'])
								away_team.goals_pro -= parseInt(game['away_goals'])
								away_team.goals_con -= parseInt(game['home_goals'])
								away_team.sg -= parseInt(game['away_goals']) - parseInt(game['home_goals'])
								if (parseInt(game['home_goals']) > parseInt(game['away_goals'])){
									home_team.points -= 3
									home_team.wins -= 1
									away_team.loss -= 1
								}
								if (parseInt(game['home_goals']) == parseInt(game['away_goals'])){
									home_team.points -= 1
									away_team.points -= 1
									home_team.draws -= 1
									away_team.draws -= 1
								}
								if (parseInt(game['away_goals']) > parseInt(game['home_goals'])){
									away_team.points -= 3
									away_team.wins -= 1
									home_team.loss -= 1
								}
								gameLocalStorage['simulated'] = false
								gameLocalStorage['home_goals'] = null
								gameLocalStorage['away_goals'] = null
								localStorage.setItem('generalData', JSON.stringify(generaldata));
							}
									
									function ft_sort_table(generalData) {
										if (generalData['league_data']['name'] == 'Premier League'){
											generalData['teams'].sort((a, b) => {
												if (a.points != b.points) {
													return b.points - a.points;
												} else {
													if (a.sg != b.sg) {
														return b.sg - a.sg;
													} else {
														return b.goals_pro - a.goals_pro;
													}
												}
											});
										}
										else if (generalData['league_data']['name'] == 'Brasileiro Serie A' || generalData['league_data']['name'] == 'Brasileiro Serie B'){
											generalData['teams'].sort((a, b) => {
												if (a.points != b.points) {
													return b.points - a.points;
												} else {
													if (a.wins != b.wins) {
														return b.wins - a.wins;
													} else {
														return b.sg - a.sg;
													}
												}
											});
										}
										else if (generalData['league_data']['name'] == 'Bundesliga'){
											generalData['teams'].sort((a, b) => {
												if (a.points != b.points) {
													return b.points - a.points;
												} else {
													if (a.sg != b.sg) {
														return b.sg - a.sg;
													} else {
														return b.goals_pro - a.goals_pro;
													}
												}
											});
										}
										else if (generalData['league_data']['name'] == 'La Liga' || generalData['league_data']['name'] == 'Serie A'){
											generaldata['teams'].sort((a, b) => b.points - a.points);
										}
										localStorage.setItem('generalData', JSON.stringify(generaldata));
									}
									function exec_game(game, generaldata) {
										let gameLocalStorage = generaldata['games'].find(object => object['game_id'] == game.game_id)
										var home_team = game['home_team'];
										var away_team = game['away_team'];
										var home_team_data = generaldata['teams'].find(team => team.name === home_team);
										var away_team_data = generaldata['teams'].find(team => team.name === away_team);
										gameLocalStorage['simulated'] = true
										console.log(home_team_data);
										console.log(away_team_data);
										home_team_data.goals_pro += parseInt(game['home_goals']);
										home_team_data.goals_con += parseInt(game['away_goals']);
										home_team_data.sg += parseInt(game['home_goals']) - parseInt(game['away_goals']);
										home_team_data.games_played += 1;
										away_team_data.goals_pro += parseInt(game['away_goals']);
										away_team_data.goals_con += parseInt(game['home_goals']);
										away_team_data.sg += parseInt(game['away_goals']) - parseInt(game['home_goals']);
										away_team_data.games_played += 1;
										if (parseInt(game['home_goals']) > parseInt(game['away_goals'])) {
											home_team_data.points += 3;
											home_team_data.wins += 1;
											away_team_data.loss += 1;
										} else if (parseInt(game['home_goals']) == parseInt(game['away_goals'])) {
											home_team_data.draws += 1;
											away_team_data.draws += 1;
											home_team_data.points += 1;
											away_team_data.points += 1;
										} else {
											away_team_data.points += 3;
											away_team_data.wins += 1;
											home_team_data.loss += 1;
										}	
										gameLocalStorage['home_goals'] = parseInt(game['home_goals'])
										gameLocalStorage['away_goals'] = parseInt(game['away_goals'])
										home_team_data.aproveitamento = ((home_team_data.points / (home_team_data.games_played * 3)) * 100).toFixed(1);
										away_team_data.aproveitamento = ((away_team_data.points / (away_team_data.games_played * 3)) * 100).toFixed(1);
										ft_sort_table(generaldata)
										generaldata['teams'].sort((a, b) => b.points - a.points);
										localStorage.setItem('generalData', JSON.stringify(generaldata));
										console.log("depois de exec game");
										console.log(away_team_data);
										console.log(home_team_data);
										console.log(gameLocalStorage);
									}
								
									function print_table(generaldata) {
										const tbody = document.querySelector('tbody')
										tbody.innerHTML = ''
										generaldata['teams'].forEach((team, index) => {
											const row = document.createElement('tr');
											row.id = `team_row_${team.id_name}`;
											let backgroundColor = '';
											let textColor = 'black';
								
											if (index + 1 <= generaldata['league_data']['zone_1']) {
												backgroundColor = 'green';
												textColor = 'white';
											} else if (generaldata['league_data']['zone_2'] && index + 1 <= generaldata['league_data']['zone_2']) {
												backgroundColor = 'blue';
												textColor = 'white';
											} else if (generaldata['league_data']['zone_3'] && index + 1 <= generaldata['league_data']['zone_3']) {
												backgroundColor = 'rgb(199, 186, 0)';
												textColor = 'white'
											} else if (index + 1 >= generaldata['league_data']['zone_reb']) {
												backgroundColor = 'red';
												textColor = 'white'
											}
											row.innerHTML = `	
												<td class="text-center mb-4" style="background-color: ${backgroundColor}; color: ${textColor};">${index + 1}</td>
												<td><img src="${team.logo}" alt="" width="13%" height="13%"> ${team.name}</td>
												<td class="text-center mb-4">${team.points}</td>
												<td class="text-center mb-4">${team.games_played}</td>
												<td class="text-center mb-4">${team.wins}</td>
												<td class="text-center mb-4">${team.draws}</td>
												<td class="text-center mb-4">${team.loss}</td>
												<td class="text-center mb-4">${team.goals_pro}</td>
												<td class="text-center mb-4">${team.goals_con}</td>
												<td class="text-center mb-4">${team.sg}</td>
												<td class="text-center mb-4">${team.aproveitamento}%</td>
												`;
											tbody.appendChild(row);
										})
									}
										
								
							</script>
							<form class="d-inline">	
							{% csrf_token %}
							<button id ="prev_round" type="button" class="btn btn-outline-success btn-sm" >
								<i class="fas fa-chevron-left"></i> Anterior
							</button>
							<script>
								function printRound(){
									let roundHTML = `<h4 style="font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;">RODADA ${window.Round}</h4>`
									document.getElementById('round_container').innerHTML = roundHTML
									document.getElementById('prev_round').disabled = (window.Round == 1)
								}

								document.addEventListener('DOMContentLoaded', function(){
									var prevRoundtButton = document.getElementById('prev_round');

									prevRoundtButton.addEventListener('click', function(){
										window.Round -= 1
										var numberOfTeams = JSON.parse(localStorage.getItem('generalData'))['teams'].length;
										var numberOfRounds = (numberOfTeams - 1) * 2
										if (window.Round == 1)
											document.getElementById('prev_round').disabled = true;
										else if (window.Round == numberOfRounds - 1)
											document.getElementById('next_round').disabled = false;
										printGamesRound(window.Round)
									})
								})
							</script>
							</form>
							<div id="round_container"></div>
							<form class="d-inline">
								{% csrf_token %}
								<button id = "next_round" type ="button" class="btn btn-outline-success btn-sm">
									Próxima <i class="fas fa-chevron-right"></i>
								</button>
								<script>
									document.addEventListener('DOMContentLoaded', function(){
										var nextRoundtButton = document.getElementById('next_round');
										
										nextRoundtButton.addEventListener('click', function(){
											window.Round += 1
											var numberOfTeams = JSON.parse(localStorage.getItem('generalData'))['teams'].length;
											var lastRound = (numberOfTeams - 1) * 2
											if (window.Round == lastRound)
												document.getElementById('next_round').disabled = true;
											else if (window.Round == 2)
												document.getElementById('prev_round').disabled = false;
											printGamesRound(window.Round)
										})
									})
								</script>
							</form>
						</div>
					<div id="gamesContainer"></div>
			</div>
		</div>
		<br>
</body>
<div align="center">
	<form method="post">
		{% csrf_token %}
		<button type="submit" id ="restart" class="btn btn-outline-success btn-sm">
			Restart <i class="fas fa-chevron-right"></i>
		</button>
		<script>
			document.addEventListener('DOMContentLoaded', function(){
				var restartButton = document.getElementById('restart');
				
				restartButton.addEventListener('click', function(){
					localStorage.removeItem('generalData')
				})
			})
		</script>
	</form>
</div>
<meta name="csrf-token" content="{{ csrf_token }}">
<br>
</html>

